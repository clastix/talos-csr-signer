# Talos Workers with Kubeadm Control Planes - Architecture Guide

## Problem Statement

Talos Linux is designed to run complete Kubernetes clusters with both control plane and worker nodes. However, many organizations want to:

1. **Keep existing kubeadm-based control planes** (including Kamaji multi-tenant control planes)
2. **Use Talos for worker nodes** to gain security, immutability, and minimal attack surface

**Challenge:** When attempting to join Talos workers to kubeadm control planes:
- ✅ Kubernetes functionality works (kubelet joins, pods run)
- ❌ Talos API (apid service) fails to start - no `talosctl` access

## Root Cause: Dual PKI Architecture

Kubernetes clusters operate with **two separate certificate authorities**:

### 1. Kubernetes PKI
- **Certificate Authority:** `/etc/kubernetes/pki/ca.crt` (managed by kubeadm)
- **Purpose:** Signs kubelet client certificates, API server certificates
- **Authentication:** Bootstrap tokens (kubeadm standard)
- **Protocol:** Kubernetes TLS bootstrapping
- **Status with Talos workers:** ✅ Works automatically

### 2. Talos Machine PKI
- **Certificate Authority:** Talos `machine.ca` (generated by `talosctl gen config`)
- **Purpose:** Signs Talos API certificates (apid, trustd services)
- **Authentication:** Talos machine token (gRPC metadata)
- **Protocol:** Talos Security Service (gRPC)
- **Status with kubeadm:** ❌ Not available - requires `trustd` service

**The Problem:** Kubeadm control planes don't run Talos `trustd` service, so Talos workers cannot obtain API certificates.

## Solution Architecture

### Goal
Enable Talos workers to join kubeadm control planes with **full functionality**:
1. Kubernetes operations (pods, services, networking)
2. Talos API access (logs, upgrades, console via `talosctl`)

### Approach

The solution involves two complementary components:

#### Component 1: Kubernetes Integration (Built-in)
Talos kubelet is a standard Kubernetes kubelet running in a container. It uses Kubernetes bootstrap tokens for authentication.

**Architecture:**
```
┌─────────────────────────────┐
│  Kubeadm Control Plane      │
│  ┌──────────────────────┐   │
│  │   kube-apiserver     │   │◄──── Port 6443
│  │   (Kubernetes PKI)   │   │
│  └──────────────────────┘   │
└──────────────┬──────────────┘
               │
               │ Bootstrap Token Auth
               │ TLS Bootstrapping
               │
    ┌──────────▼─────────┐
    │   Talos Worker     │
    │  ┌──────────────┐  │
    │  │   kubelet    │  │
    │  │ (container)  │  │
    │  └──────────────┘  │
    │                    │
    └────────────────────┘
```

**How it works:**
1. Talos worker configured with kubeadm API endpoint and bootstrap token
2. Kubelet uses bootstrap token to authenticate to kube-apiserver
3. Kubelet receives signed certificate from Kubernetes CA
4. Node joins cluster, pods can be scheduled

**Configuration requirements:**
- `cluster.controlPlane.endpoint` → kubeadm API server
- `cluster.ca.crt` → Kubernetes CA certificate (base64)
- `cluster.token` → kubeadm bootstrap token
- `cluster.network.cni.name: none` → kubeadm manages CNI

#### Component 2: Talos API Access (CSR Signer Service)

To enable `talosctl` functionality, we implement the Talos Security Service protocol.

**Architecture:**
```
┌─────────────────────────────────────────────────────────┐
│ Kubeadm/Kamaji Control Plane                            │
│                                                         │
│  ┌─────────────────┐     ┌──────────────────────────┐   │
│  │ kube-apiserver  │     │ talos-csr-signer         │   │
│  │ Port 6443       │     │ Port 50001               │   │
│  │ (Kubernetes PKI)│     │ (Talos Machine PKI)      │   │
│  └─────────────────┘     └──────────────────────────┘   │
│                                                         │
│  Same IP (10.10.10.101) - Different Ports               │
└───────────────────┬──────────────────┬──────────────────┘
                    │                  │
                    │                  │
    ┌───────────────▼──────────────────▼──────────┐
    │         Talos Worker                        │
    │                                             │
    │  ┌────────────┐           ┌─────────────┐   │
    │  │  kubelet   │           │    apid     │   │
    │  │            │           │  (Talos API)│   │
    │  └─────┬──────┘           └──────┬──────┘   │
    │        │                         │          │
    │        │ Bootstrap               │ Machine  │
    │        │ Token                   │ Token    │
    │        │                         │          │
    │        ▼                         ▼          │
    │   Port 6443                Port 50001       │
    │   Kubernetes Auth          CSR Signing      │
    │                                             │
    └─────────────────────────────────────────────┘
```

**CSR Signer Service:**
- **Role:** Implements Talos `trustd` Security Service gRPC protocol
- **Deployment:** Kubernetes pod with LoadBalancer service (port 50001)
- **Authentication:** Talos machine token (from `talosctl gen config`)
- **Function:** Signs Talos worker CSRs to issue apid certificates
- **High Availability:** Multi-replica deployment with shared IP

**How it works:**
1. Talos worker's `apid` service generates CSR for API certificate
2. Worker uses discovery to find CSR signer at control plane IP:50001
3. CSR signer validates machine token (gRPC metadata)
4. CSR signer signs certificate using Talos Machine CA
5. Worker receives certificate, apid service starts
6. `talosctl` can now communicate with worker

**Key implementation details:**
- Shares same LoadBalancer IP as kube-apiserver (different port)
- Uses MetalLB `allow-shared-ip` annotation
- Workers require `discovery.enabled: true` to locate CSR signer
- Token authentication via gRPC metadata (not HTTP headers)
- TLS certificate chain includes both server cert and CA cert

## Implementation Components

### 1. Talos Worker Configuration

**Purpose:** Configure worker to authenticate to both PKI systems

**Critical settings:**
```yaml
cluster:
  # Kubernetes PKI
  controlPlane:
    endpoint: https://10.10.10.101:6443
  ca:
    crt: <kubeadm-ca-base64>
  token: <kubeadm-bootstrap-token>

  # Enable discovery for CSR signer
  discovery:
    enabled: true  # Required to find CSR signer

  # Network must match kubeadm
  network:
    cni:
      name: none  # kubeadm manages CNI
```

### 2. CSR Signer Service Deployment

**Purpose:** Provide Talos trustd functionality for kubeadm control planes

**Components:**
- **Secret:** Talos Machine CA certificate and private key + token
- **Deployment:** gRPC server (2 replicas for HA)
- **Service:** LoadBalancer with MetalLB IP sharing
- **RBAC:** EndpointSlice permissions (workers use for discovery)

**Network configuration:**
```yaml
apiVersion: v1
kind: Service
metadata:
  annotations:
    metallb.io/allow-shared-ip: "shared-ip"  # Share IP with kube-apiserver
spec:
  type: LoadBalancer
  loadBalancerIP: 10.10.10.101  # Same as control plane
  ports:
    - port: 50001  # CSR signer port
```

### 3. MetalLB IP Sharing

**Purpose:** Allow both kube-apiserver and CSR signer to share same LoadBalancer IP

**Configuration:**
- Control plane service: `10.10.10.101:6443`
- CSR signer service: `10.10.10.101:50001`
- Both use annotation: `metallb.io/allow-shared-ip: "shared-ip"`
- MetalLB routes traffic by port

## Security Model

### Kubernetes PKI Security
- Bootstrap tokens are time-limited (default 24h)
- Tokens can be rotated or set to never expire (`ttl 0`)
- Kubelet certificates auto-rotate via CSR approval
- CSR approval handled by kubeadm ClusterRoleBindings

### Talos Machine PKI Security
- Machine CA private key stored in Kubernetes Secret
- Only CSR signer pods can access CA private key
- Workers never have CA private key (only CA certificate)
- Token authentication required for all CSR requests
- TLS encryption for all gRPC communication

## Operational Workflows

### Adding New Worker
1. Obtain kubeadm bootstrap token
2. Create Talos worker config with kubeadm endpoint and token
3. Deploy worker with `talosctl apply-config`
4. Worker kubelet authenticates to kube-apiserver (Kubernetes PKI)
5. Worker apid sends CSR to CSR signer (Talos Machine PKI)
6. CSR signer validates token and signs certificate
7. Worker fully operational (Kubernetes + Talos API)

### Token Rotation
**Kubernetes tokens:**
- Create new token: `kubeadm token create --ttl 8760h`
- Update worker config with new token
- Reapply configuration

**Talos tokens:**
- Generate new config: `talosctl gen config`
- Extract new token and CA
- Update CSR signer secret
- Recreate CSR signer pods
- Update worker configs with new token/CA

### Scaling CSR Signer
- Increase replicas in deployment
- All replicas share same LoadBalancer IP
- No coordination needed (stateless service)
- Each replica can independently sign CSRs

## Why This Works

### Talos Kubelet is Standard Kubernetes
The Talos kubelet is identical to kubelet running in any Kubernetes distribution. It:
- Uses standard bootstrap token authentication
- Follows Kubernetes TLS bootstrapping protocol
- Generates standard Kubernetes CSRs
- Doesn't require Talos-specific control plane components

### Separation of Concerns
- **Kubernetes PKI:** Handles cluster membership and workload authentication
- **Talos Machine PKI:** Handles node management and administrative access
- These are **independent systems** - one can work without the other

### CSR Signer Compatibility
The CSR signer is compatible with any kubeadm-based control plane:
- Standard kubeadm clusters
- Kamaji multi-tenant control planes
- Managed Kubernetes with kubeadm bootstrap
- Any system that exposes kube-apiserver on standard port

## Limitations and Considerations

### What Works
- ✅ Full Kubernetes functionality (pods, services, storage, networking)
- ✅ Standard kubectl operations
- ✅ Talos security and immutability benefits
- ✅ Talos API access (with CSR signer)
- ✅ Talos upgrades and maintenance

### Network Requirements
- Workers must reach control plane IP on both ports (6443 + 3182 + 50001)
- If using separate IPs, workers need routes to both
- Firewall rules must allow both ports
- CNI must support pod networking to Talos workers

### Bootstrap Token Management
- Tokens expire by default (24h)
- Production deployments should use long-lived tokens (`ttl 0`)
- Token rotation requires updating all worker configs
- Consider automation for token lifecycle management

## References

**External Documentation:**
- [Talos Documentation](https://www.talos.dev)
- [Kubernetes TLS Bootstrapping](https://kubernetes.io/docs/reference/access-authn-authz/bootstrap-tokens/)
- [Kubeadm Documentation](https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/)
- [Kamaji Architecture](https://kamaji.clastix.io/)
